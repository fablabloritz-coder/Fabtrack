{% extends "base.html" %}
{% block title %}Statistiques{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="mb-4 d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
        <h1 class="page-title"><i class="bi bi-bar-chart-line"></i> Statistiques</h1>
        <p class="page-subtitle">Visualisez la consommation du Fablab sur la p√©riode souhait√©e</p>
    </div>
    <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-primary btn-sm" onclick="exportStatsPDF()" title="Imprimer / PDF">
            <i class="bi bi-printer me-1"></i> PDF
        </button>
        <button class="btn btn-outline-success btn-sm" onclick="exportStatsHTML()" title="Exporter en HTML">
            <i class="bi bi-filetype-html me-1"></i> HTML
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportStatsCSV()" title="Exporter les donn√©es en CSV">
            <i class="bi bi-filetype-csv me-1"></i> CSV
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label small fw-bold">P√©riode d√©but</label>
                <input type="date" id="statDateDebut" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">P√©riode fin</label>
                <input type="date" id="statDateFin" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Regrouper par</label>
                <select id="statGroupBy" class="form-select">
                    <option value="day">Jour</option>
                    <option value="week">Semaine</option>
                    <option value="month" selected>Mois</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">Raccourcis</label>
                <div class="filter-tabs">
                    <button class="filter-tab" onclick="setPreset('week', this)">7j</button>
                    <button class="filter-tab" onclick="setPreset('month', this)">30j</button>
                    <button class="filter-tab" onclick="setPreset('semester', this)">Semestre</button>
                    <button class="filter-tab" onclick="setPreset('year', this)">Ann√©e</button>
                    <button class="filter-tab active" onclick="setPreset('all', this)">Tout</button>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="loadStats()">
                    <i class="bi bi-arrow-repeat"></i> Actualiser
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-number text-primary" id="statTotal">‚Äî</div>
            <div class="stat-label"><i class="bi bi-journal-text me-1"></i> Interventions</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-number text-warning" id="stat3D">‚Äî</div>
            <div class="stat-label"><i class="bi bi-printer me-1"></i> Filament 3D</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-number text-danger" id="statLaser">‚Äî</div>
            <div class="stat-label"><i class="bi bi-scissors me-1"></i> Surface d√©coupe</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-number text-success" id="statPapier">‚Äî</div>
            <div class="stat-label"><i class="bi bi-file-earmark me-1"></i> Feuilles imprim√©es</div>
            <div class="d-flex justify-content-center gap-3 mt-1" style="font-size:.78rem;">
                <span class="text-primary"><i class="bi bi-palette-fill"></i> <span id="statPapierCouleur">‚Äî</span> couleur</span>
                <span class="text-secondary"><i class="bi bi-circle-half"></i> <span id="statPapierNB">‚Äî</span> N&B</span>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row g-4">
    <!-- By Type -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-pie-chart me-1"></i> R√©partition par type d'activit√©</h3>
            <canvas id="chartByType"></canvas>
        </div>
    </div>

    <!-- By Preparateur -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-people me-1"></i> R√©partition par pr√©parateur</h3>
            <canvas id="chartByPrep"></canvas>
        </div>
    </div>

    <!-- Timeline -->
    <div class="col-12">
        <div class="chart-card">
            <h3><i class="bi bi-graph-up me-1"></i> √âvolution des interventions</h3>
            <canvas id="chartTimeline"></canvas>
        </div>
    </div>

    <!-- 3D Consumption -->
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <h3 class="mb-0"><i class="bi bi-printer me-1"></i> Consommation 3D par filament (g)</h3>
                <select id="filter3DMat" class="form-select form-select-sm" style="width:auto;min-width:130px;" onchange="rerender3D()">
                    <option value="">Tous les mat√©riaux</option>
                </select>
            </div>
            <canvas id="chart3D"></canvas>
        </div>
    </div>

    <!-- Laser Consumption -->
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <h3 class="mb-0"><i class="bi bi-scissors me-1"></i> Surface d√©coupe par mat√©riau (m¬≤)</h3>
                <select id="filterLaserMat" class="form-select form-select-sm" style="width:auto;min-width:130px;" onchange="rerenderLaser()">
                    <option value="">Tous les mat√©riaux</option>
                </select>
            </div>
            <canvas id="chartLaser"></canvas>
        </div>
    </div>

    <!-- Top Machines -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-cpu me-1"></i> Top 10 machines</h3>
            <canvas id="chartMachines"></canvas>
        </div>
    </div>

    <!-- Top Classes -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-mortarboard me-1"></i> Top 10 classes</h3>
            <canvas id="chartClasses"></canvas>
        </div>
    </div>

    <!-- Paper Consumption (Color / B&W) -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-file-earmark me-1"></i> Feuilles imprim√©es (Couleur / N&B)</h3>
            <canvas id="chartPapier"></canvas>
        </div>
    </div>

    <!-- Paper Format Breakdown -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-file-earmark-text me-1"></i> Feuilles par format (Couleur / N&B)</h3>
            <canvas id="chartPapierFormat"></canvas>
        </div>
    </div>

    <!-- ===== Activit√© journali√®re ===== -->
    <div class="col-12 mt-4">
        <h2 class="h5 fw-bold"><i class="bi bi-clock-history me-1"></i> Activit√© journali√®re</h2>
        <p class="text-muted small">R√©partition des saisies par heure et par jour de la semaine</p>
    </div>

    <!-- Filtres sp√©cifiques activit√© -->
    <div class="col-12">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold mb-1">Pr√©parateur</label>
                        <select id="actFilterPrep" class="form-select form-select-sm" onchange="loadActivity()">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold mb-1">Machine</label>
                        <select id="actFilterMachine" class="form-select form-select-sm" onchange="loadActivity()">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- By Hour -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-hourglass-split me-1"></i> Saisies par tranche horaire</h3>
            <canvas id="chartByHour"></canvas>
        </div>
    </div>

    <!-- By Day of Week -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h3><i class="bi bi-calendar-week me-1"></i> Saisies par jour de semaine</h3>
            <canvas id="chartByDow"></canvas>
        </div>
    </div>

    <!-- By Hour + Preparateur -->
    <div class="col-12">
        <div class="chart-card">
            <h3><i class="bi bi-people me-1"></i> Activit√© par heure et pr√©parateur</h3>
            <canvas id="chartHourPrep"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let charts = {};
let rawData3D = [];
let rawDataLaser = [];

function onReferenceDataLoaded() {
    // Populate activity filters
    const prepSel = document.getElementById('actFilterPrep');
    REF_DATA.preparateurs.forEach(p => {
        prepSel.innerHTML += `<option value="${p.id}">${p.nom}</option>`;
    });
    const machSel = document.getElementById('actFilterMachine');
    REF_DATA.machines.forEach(m => {
        machSel.innerHTML += `<option value="${m.id}">${m.nom}</option>`;
    });

    setPreset('all', document.querySelector('.filter-tab.active'));
}

function setPreset(preset, btn) {
    const now = new Date();
    let debut = '';
    let fin = now.toISOString().split('T')[0];

    // Update active tab
    document.querySelectorAll('.filter-tabs .filter-tab').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');

    switch (preset) {
        case 'week':
            debut = new Date(now - 7 * 86400000).toISOString().split('T')[0];
            document.getElementById('statGroupBy').value = 'day';
            break;
        case 'month':
            debut = new Date(now - 30 * 86400000).toISOString().split('T')[0];
            document.getElementById('statGroupBy').value = 'day';
            break;
        case 'semester':
            debut = new Date(now.getFullYear(), now.getMonth() - 6, 1).toISOString().split('T')[0];
            document.getElementById('statGroupBy').value = 'month';
            break;
        case 'year':
            debut = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
            document.getElementById('statGroupBy').value = 'month';
            break;
        case 'all':
            debut = '';
            fin = '';
            document.getElementById('statGroupBy').value = 'month';
            break;
    }
    document.getElementById('statDateDebut').value = debut;
    document.getElementById('statDateFin').value = fin;
    loadStats();
    loadActivity();
}

async function loadStats() {
    const params = new URLSearchParams({
        date_debut: document.getElementById('statDateDebut').value,
        date_fin: document.getElementById('statDateFin').value,
        group_by: document.getElementById('statGroupBy').value,
    });

    try {
        const [summaryRes, timelineRes] = await Promise.all([
            fetch(`/api/stats/summary?${params}`),
            fetch(`/api/stats/timeline?${params}`),
        ]);
        const summary = await summaryRes.json();
        const timeline = await timelineRes.json();

        updateCards(summary);
        renderCharts(summary, timeline);
        loadActivity();
    } catch (err) {
        console.error('Stats error:', err);
        showToast('Erreur chargement statistiques', 'error');
    }
}

function updateCards(s) {
    document.getElementById('statTotal').textContent = s.total_interventions;
    document.getElementById('stat3D').textContent =
        s.total_3d_grammes > 1000
            ? `${(s.total_3d_grammes / 1000).toFixed(2)} kg`
            : `${s.total_3d_grammes} g`;
    document.getElementById('statLaser').textContent = `${s.total_decoupe_m2} m¬≤`;
    document.getElementById('statPapier').textContent = `${s.total_papier_feuilles}`;
    document.getElementById('statPapierCouleur').textContent = s.total_papier_couleur;
    document.getElementById('statPapierNB').textContent = s.total_papier_nb;
}

function destroyChart(name) {
    if (charts[name]) { charts[name].destroy(); charts[name] = null; }
}

function renderCharts(summary, timeline) {
    renderByType(summary.by_type);
    renderByPrep(summary.by_preparateur);
    renderTimeline(timeline.timeline);
    render3D(timeline.timeline_3d);
    renderLaser(timeline.timeline_decoupe);
    renderPapier(timeline.timeline_papier);
    renderPapierFormat(summary);
    renderMachines(timeline.top_machines);
    renderClasses(timeline.top_classes);
}

function renderByType(data) {
    destroyChart('byType');
    const ctx = document.getElementById('chartByType').getContext('2d');
    const total = data.reduce((s, d) => s + d.count, 0);
    charts.byType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => `${d.icone} ${d.nom}`),
            datasets: [{
                data: data.map(d => d.count),
                backgroundColor: data.map(d => d.couleur),
                borderWidth: 2, borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 12 } } },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const val = ctx.parsed;
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return ` ${ctx.label}: ${val} (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderByPrep(data) {
    destroyChart('byPrep');
    const ctx = document.getElementById('chartByPrep').getContext('2d');
    const colors = ['#e67e22', '#3b82f6', '#22c55e', '#ef4444', '#a855f7', '#ec4899'];
    const total = data.reduce((s, d) => s + d.count, 0);
    charts.byPrep = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(d => d.nom),
            datasets: [{
                data: data.map(d => d.count),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 2, borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 12 } } },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const val = ctx.parsed;
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return ` ${ctx.label}: ${val} (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderTimeline(data) {
    destroyChart('timeline');
    const ctx = document.getElementById('chartTimeline').getContext('2d');
    const periods = [...new Set(data.map(d => d.period))].sort();
    const types = [...new Set(data.map(d => d.type_nom))];

    const datasets = types.map(t => {
        const rows = data.filter(d => d.type_nom === t);
        const color = rows[0]?.couleur || '#999';
        return {
            label: t,
            data: periods.map(p => {
                const r = rows.find(d => d.period === p);
                return r ? r.count : 0;
            }),
            backgroundColor: color, borderColor: color, borderWidth: 1
        };
    });

    charts.timeline = new Chart(ctx, {
        type: 'bar',
        data: { labels: periods, datasets },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Interventions' } }
            },
            plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } }
        }
    });
}

function render3D(data) {
    destroyChart('chart3D');
    rawData3D = data || [];
    const ctx = document.getElementById('chart3D').getContext('2d');
    if (!data || data.length === 0) {
        charts.chart3D = new Chart(ctx, {
            type: 'bar', data: { labels: ['Pas de donn√©es'], datasets: [{ data: [0] }] },
            options: { responsive: true }
        });
        return;
    }
    // Populate filter dropdown
    const sel = document.getElementById('filter3DMat');
    const curVal = sel.value;
    const allMats = [...new Set(data.map(d => d.materiau || 'Inconnu'))].sort();
    sel.innerHTML = '<option value="">Tous les mat√©riaux</option>' + allMats.map(m => `<option value="${m}">${m}</option>`).join('');
    sel.value = curVal;

    // Apply filter
    const filtered = curVal ? data.filter(d => (d.materiau || 'Inconnu') === curVal) : data;
    const materials = [...new Set(filtered.map(d => d.materiau || 'Inconnu'))];
    const periods = [...new Set(filtered.map(d => d.period))].sort();
    const colors = ['#f59e0b', '#ef4444', '#3b82f6', '#22c55e', '#a855f7'];

    const datasets = materials.map((m, i) => ({
        label: m,
        data: periods.map(p => {
            const r = filtered.find(d => d.period === p && (d.materiau || 'Inconnu') === m);
            return r ? r.total_g : 0;
        }),
        backgroundColor: colors[i % colors.length]
    }));

    charts.chart3D = new Chart(ctx, {
        type: 'bar', data: { labels: periods, datasets },
        options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Grammes' } } },
            plugins: { legend: { position: 'top' } }
        }
    });
}

function rerender3D() {
    render3D(rawData3D);
}

function renderLaser(data) {
    destroyChart('chartLaser');
    rawDataLaser = data || [];
    const ctx = document.getElementById('chartLaser').getContext('2d');
    if (!data || data.length === 0) {
        charts.chartLaser = new Chart(ctx, {
            type: 'bar', data: { labels: ['Pas de donn√©es'], datasets: [{ data: [0] }] },
            options: { responsive: true }
        });
        return;
    }
    // Populate filter dropdown
    const sel = document.getElementById('filterLaserMat');
    const curVal = sel.value;
    const allMats = [...new Set(data.map(d => d.materiau || 'Inconnu'))].sort();
    sel.innerHTML = '<option value="">Tous les mat√©riaux</option>' + allMats.map(m => `<option value="${m}">${m}</option>`).join('');
    sel.value = curVal;

    // Apply filter
    const filtered = curVal ? data.filter(d => (d.materiau || 'Inconnu') === curVal) : data;
    const materials = [...new Set(filtered.map(d => d.materiau || 'Inconnu'))];
    const periods = [...new Set(filtered.map(d => d.period))].sort();
    const colors = ['#ef4444', '#f97316', '#84cc16', '#06b6d4', '#8b5cf6'];

    const datasets = materials.map((m, i) => ({
        label: m,
        data: periods.map(p => {
            const r = filtered.find(d => d.period === p && (d.materiau || 'Inconnu') === m);
            return r ? r.total_m2 : 0;
        }),
        backgroundColor: colors[i % colors.length]
    }));

    charts.chartLaser = new Chart(ctx, {
        type: 'bar', data: { labels: periods, datasets },
        options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'm¬≤' } } },
            plugins: { legend: { position: 'top' } }
        }
    });
}

function rerenderLaser() {
    renderLaser(rawDataLaser);
}

function renderPapier(data) {
    destroyChart('chartPapier');
    const ctx = document.getElementById('chartPapier').getContext('2d');
    if (!data || data.length === 0) {
        charts.chartPapier = new Chart(ctx, {
            type: 'bar', data: { labels: ['Pas de donn√©es'], datasets: [{ data: [0] }] },
            options: { responsive: true }
        });
        return;
    }
    const periods = [...new Set(data.map(d => d.period))].sort();
    const types = [...new Set(data.map(d => d.type_impression))];
    const colorMap = { 'Couleur': '#3b82f6', 'N&B': '#94a3b8', 'Autre': '#e5e7eb' };

    const datasets = types.map(t => ({
        label: t,
        data: periods.map(p => {
            const r = data.find(d => d.period === p && d.type_impression === t);
            return r ? r.total_feuilles : 0;
        }),
        backgroundColor: colorMap[t] || '#999'
    }));

    charts.chartPapier = new Chart(ctx, {
        type: 'bar', data: { labels: periods, datasets },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Feuilles' } }
            },
            plugins: { legend: { position: 'top' } }
        }
    });
}

function renderPapierFormat(summary) {
    destroyChart('chartPapierFormat');
    const ctx = document.getElementById('chartPapierFormat').getContext('2d');
    const couleur = summary.total_papier_couleur || 0;
    const nb = summary.total_papier_nb || 0;
    const autre = (summary.total_papier_feuilles || 0) - couleur - nb;
    const data = [];
    const labels = [];
    const colors = [];
    if (couleur > 0) { data.push(couleur); labels.push('Couleur'); colors.push('#3b82f6'); }
    if (nb > 0) { data.push(nb); labels.push('Noir & Blanc'); colors.push('#94a3b8'); }
    if (autre > 0) { data.push(autre); labels.push('Autre'); colors.push('#e5e7eb'); }
    if (data.length === 0) { data.push(0); labels.push('Pas de donn√©es'); colors.push('#e5e7eb'); }
    const total = data.reduce((s, v) => s + v, 0);
    charts.chartPapierFormat = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { font: { size: 12 } } },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const val = ctx.parsed;
                            const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                            return ` ${ctx.label}: ${val} feuilles (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderMachines(data) {
    destroyChart('chartMachines');
    const ctx = document.getElementById('chartMachines').getContext('2d');
    charts.chartMachines = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.nom),
            datasets: [{
                label: 'Utilisations',
                data: data.map(d => d.count),
                backgroundColor: data.map(d => d.couleur || '#e67e22'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true, indexAxis: 'y',
            scales: { x: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderClasses(data) {
    destroyChart('chartClasses');
    const ctx = document.getElementById('chartClasses').getContext('2d');
    const colors = ['#e67e22', '#d35400', '#f59e0b', '#b45309', '#ea580c',
                    '#c2410c', '#fb923c', '#fdba74', '#fde68a', '#fef3c7'];
    charts.chartClasses = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.nom),
            datasets: [{
                label: 'Interventions',
                data: data.map(d => d.count),
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true, indexAxis: 'y',
            scales: { x: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
}

/* ===== Activit√© journali√®re ===== */
const DOW_LABELS = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
const HOUR_LABELS = Array.from({length:24}, (_, i) => `${String(i).padStart(2,'0')}h`);
const ACTIVITY_COLORS = ['#e67e22','#3b82f6','#22c55e','#ef4444','#a855f7','#ec4899','#14b8a6','#f59e0b','#6366f1','#84cc16'];

async function loadActivity() {
    const params = new URLSearchParams({
        date_debut: document.getElementById('statDateDebut').value,
        date_fin: document.getElementById('statDateFin').value,
        preparateur_id: document.getElementById('actFilterPrep').value,
        machine_id: document.getElementById('actFilterMachine').value,
    });
    try {
        const res = await fetch(`/api/stats/activity?${params}`);
        const data = await res.json();
        renderByHour(data.by_hour);
        renderByDow(data.by_day_of_week);
        renderHourPrep(data.by_hour_prep);
    } catch(err) {
        console.error('Activity stats error:', err);
    }
}

function renderByHour(data) {
    destroyChart('byHour');
    const ctx = document.getElementById('chartByHour').getContext('2d');
    const counts = new Array(24).fill(0);
    data.forEach(d => { counts[d.hour] = d.count; });
    charts.byHour = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: HOUR_LABELS,
            datasets: [{
                label: 'Saisies',
                data: counts,
                backgroundColor: counts.map((v, i) => i >= 8 && i <= 17 ? '#e67e22' : '#fcd9b6'),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Nombre' } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderByDow(data) {
    destroyChart('byDow');
    const ctx = document.getElementById('chartByDow').getContext('2d');
    const counts = new Array(7).fill(0);
    data.forEach(d => { counts[d.dow] = d.count; });
    // R√©ordonner: Lundi(1)..Dimanche(0)
    const orderedLabels = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
    const orderedCounts = [counts[1], counts[2], counts[3], counts[4], counts[5], counts[6], counts[0]];
    const dowColors = orderedCounts.map((_, i) => i < 5 ? '#3b82f6' : '#94a3b8');
    charts.byDow = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: orderedLabels,
            datasets: [{
                label: 'Saisies',
                data: orderedCounts,
                backgroundColor: dowColors,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Nombre' } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderHourPrep(data) {
    destroyChart('hourPrep');
    const ctx = document.getElementById('chartHourPrep').getContext('2d');
    const preps = [...new Set(data.map(d => d.preparateur))];
    const datasets = preps.map((name, i) => {
        const counts = new Array(24).fill(0);
        data.filter(d => d.preparateur === name).forEach(d => { counts[d.hour] = d.count; });
        return {
            label: name,
            data: counts,
            backgroundColor: ACTIVITY_COLORS[i % ACTIVITY_COLORS.length],
        };
    });
    charts.hourPrep = new Chart(ctx, {
        type: 'bar',
        data: { labels: HOUR_LABELS, datasets },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Saisies' } }
            },
            plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } }
        }
    });
}

/* ===== Export Functions ===== */
function exportStatsPDF() {
    window.print();
}

function exportStatsHTML() {
    // Get fablab info if available
    const fablabInfo = JSON.parse(localStorage.getItem('fabtrack_fablab_info') || '{}');
    const fablabLogoHtml = fablabInfo.logo ? `<img src="${fablabInfo.logo}" alt="Logo" style="max-height:60px;border-radius:8px;margin-bottom:0.5rem;"><br>` : '';
    const fablabHeader = fablabInfo.nom ? `
        <div style="text-align:center;margin-bottom:1.5rem;padding:1rem;background:#fef3e2;border-radius:12px;">
            ${fablabLogoHtml}
            <h2 style="margin:0;color:#e67e22;">${fablabInfo.nom}</h2>
            ${fablabInfo.annee ? `<p style="margin:0.25rem 0;color:#666;">Ann√©e : ${fablabInfo.annee}</p>` : ''}
            ${fablabInfo.adresse ? `<p style="margin:0;color:#888;font-size:0.85rem;">${fablabInfo.adresse}</p>` : ''}
        </div>
    ` : '';

    // Convert all visible canvases to images
    const canvases = document.querySelectorAll('canvas');
    const images = [];
    canvases.forEach(c => {
        try { images.push({ id: c.id, dataUrl: c.toDataURL('image/png') }); } catch(e) {}
    });

    // Collect summary cards
    const total = document.getElementById('statTotal').textContent;
    const filament = document.getElementById('stat3D').textContent;
    const decoupe = document.getElementById('statLaser').textContent;
    const papier = document.getElementById('statPapier').textContent;
    const debut = document.getElementById('statDateDebut').value || 'D√©but';
    const fin = document.getElementById('statDateFin').value || 'Aujourd\'hui';

    let chartsHtml = images.map(img => `
        <div style="page-break-inside:avoid;margin-bottom:2rem;">
            <img src="${img.dataUrl}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px;">
        </div>
    `).join('');

    const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>FabTrack ‚Äî Statistiques export</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 1100px; margin: 0 auto; padding: 2rem; color: #333; }
        h1 { color: #e67e22; }
        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1.5rem 0; }
        .summary-card { text-align: center; padding: 1rem; border: 2px solid #eee; border-radius: 12px; }
        .summary-card .number { font-size: 2rem; font-weight: 800; }
        .summary-card .label { font-size: 0.85rem; color: #666; }
        .period { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
        footer { margin-top: 3rem; text-align: center; color: #999; font-size: 0.8rem; }
    </style>
</head>
<body>
    <h1>üìä FabTrack ‚Äî Statistiques</h1>
    ${fablabHeader}
    <p class="period">P√©riode : ${debut} ‚Üí ${fin}</p>
    <div class="summary">
        <div class="summary-card"><div class="number" style="color:#3b82f6">${total}</div><div class="label">Interventions</div></div>
        <div class="summary-card"><div class="number" style="color:#f59e0b">${filament}</div><div class="label">Filament 3D</div></div>
        <div class="summary-card"><div class="number" style="color:#ef4444">${decoupe}</div><div class="label">Surface d√©coupe</div></div>
        <div class="summary-card"><div class="number" style="color:#22c55e">${papier}</div><div class="label">Feuilles imprim√©es</div></div>
    </div>
    <hr>
    ${chartsHtml}
    <footer>Export√© depuis FabTrack ‚Äî ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</footer>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `FabTrack_Stats_${new Date().toISOString().slice(0,10)}.html`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Export HTML t√©l√©charg√©', 'info');
}

async function exportStatsCSV() {
    const params = new URLSearchParams({
        date_debut: document.getElementById('statDateDebut').value,
        date_fin: document.getElementById('statDateFin').value,
    });
    try {
        const res = await fetch(`/api/consommations?per_page=99999&page=1&${params}`);
        const result = await res.json();
        if (!result.data || !result.data.length) {
            showToast('Aucune donn√©e √† exporter', 'info');
            return;
        }
        const headers = ['Date', 'Projet', 'Type activit√©', 'Machine', 'Mat√©riau', 'Poids (g)', 'Surface (m¬≤)', 'Nb feuilles', 'Pr√©parateur', 'Classe', 'Commentaire'];
        const rows = result.data.map(r => [
            r.date_saisie, r.projet_nom || '', r.type_activite_nom || '', r.machine_nom || '',
            r.materiau_nom || '', r.poids_grammes || '', r.surface_m2 || '', r.nb_feuilles || '',
            r.preparateur_nom || '', r.classe_nom || '', r.commentaire || ''
        ]);
        const csvContent = [headers, ...rows].map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `FabTrack_Export_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Export CSV t√©l√©charg√©', 'info');
    } catch(err) {
        showToast('Erreur export CSV', 'error');
    }
}
</script>
{% endblock %}
