{% extends "base.html" %}
{% block title %}Nouvelle saisie{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="mb-4">
    <h1 class="page-title"><i class="bi bi-pencil-square"></i> Nouvelle saisie</h1>
    <p class="page-subtitle">Enregistrer une ou plusieurs actions en une seule saisie</p>
</div>

<!-- ===== Section 1 : Infos projet ===== -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center px-4 py-3">
        <strong><i class="bi bi-folder2-open me-1"></i> Informations g√©n√©rales</strong>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetForm()">
            <i class="bi bi-arrow-counterclockwise"></i> R√©initialiser tout
        </button>
    </div>
    <div class="card-body px-4 py-4">
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-calendar3 me-1"></i> Date & Heure</label>
                <input type="datetime-local" id="date_saisie" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-tag me-1"></i> Intitul√© du projet (optionnel)</label>
                <input type="text" id="projet_nom" class="form-control" placeholder="Ex: Maquette pont, TP semaine 12...">
            </div>
        </div>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-mortarboard me-1"></i> Classe</label>
                <select id="classe_id" class="form-select">
                    <option value="">Optionnel...</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="bi bi-person-badge me-1"></i> R√©f√©rent</label>
                <div class="input-group">
                    <select id="referent_id" class="form-select">
                        <option value="">Optionnel...</option>
                    </select>
                    <button type="button" class="btn btn-outline-secondary" onclick="addNewReferent()" title="Ajouter un r√©f√©rent">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== Section 2 : Actions (dynamique, multi-action) ===== -->
<div id="actionsContainer"></div>

<div class="d-flex gap-2 mb-4">
    <button type="button" class="btn btn-outline-primary" onclick="addAction()">
        <i class="bi bi-plus-circle me-1"></i> Ajouter une action
    </button>
</div>

<!-- ===== Section 3 : Boutons d'enregistrement ===== -->
<div class="d-flex gap-2 flex-wrap mb-4">
    <button type="button" class="btn btn-primary btn-lg" id="submitBtn" onclick="submitForm()">
        <i class="bi bi-check-lg"></i> Enregistrer
    </button>
    <button type="button" class="btn btn-success btn-lg" id="submitAndNewBtn" onclick="submitAndNew()">
        <i class="bi bi-plus-lg"></i> Enregistrer & Nouveau
    </button>
</div>

<!-- Derni√®res saisies -->
<div class="card border-0 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center px-4 py-3">
        <strong><i class="bi bi-clock-history me-1"></i> Derni√®res saisies</strong>
        <a href="/historique" class="btn btn-outline-primary btn-sm">
            Voir tout <i class="bi bi-arrow-right"></i>
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-touch table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Projet</th>
                        <th>Type</th>
                        <th>Machine</th>
                        <th>Mat√©riau</th>
                        <th>D√©tails</th>
                        <th>Pr√©parateur</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="recentTable">
                    <tr><td colspan="8" class="text-center text-muted py-4">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ===================================================
   Multi-action saisie ‚Äì FabTrack
   =================================================== */
const DECOUPE_TYPES = ['D√©coupe Laser', 'CNC / Fraisage'];
let actionCounter = 0;   // auto-increment id for actions
let actionUnits = {};     // per-action decoupe unit

/* ---------- lifecycle ---------- */
function onReferenceDataLoaded() {
    populateGlobalSelects();
    setDefaultDate();
    addAction();           // start with one empty action
    loadRecent();

    // calculateur surface pr√©-remplissage
    const calcSurface = sessionStorage.getItem('fabtrack_calc_surface');
    if (calcSurface) {
        sessionStorage.removeItem('fabtrack_calc_surface');
        const data = JSON.parse(calcSurface);
        // will be applied to first action after it renders
        setTimeout(() => {
            const first = document.querySelector('[data-action-id]');
            if (first) {
                const aid = first.dataset.actionId;
                if (data.longueur_mm) qs(aid, '.f-longueur').value = data.longueur_mm;
                if (data.largeur_mm) qs(aid, '.f-largeur').value = data.largeur_mm;
                calcActionSurface(aid);
            }
            showToast('Surface pr√©-remplie depuis le calculateur', 'info');
        }, 100);
    }
}

function setDefaultDate() {
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    document.getElementById('date_saisie').value =
        `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

function populateGlobalSelects() {
    const classSel = document.getElementById('classe_id');
    classSel.innerHTML = '<option value="">Optionnel...</option>';
    REF_DATA.classes.forEach(c => {
        classSel.innerHTML += `<option value="${c.id}">${c.nom}</option>`;
    });

    const refSel = document.getElementById('referent_id');
    refSel.innerHTML = '<option value="">Optionnel...</option>';
    REF_DATA.referents.forEach(r => {
        const cat = r.categorie ? ` (${r.categorie})` : '';
        refSel.innerHTML += `<option value="${r.id}">${r.nom}${cat}</option>`;
    });
}

/* ---------- helpers ---------- */
function qs(aid, sel) {
    return document.querySelector(`[data-action-id="${aid}"] ${sel}`);
}

/* ---------- Add / Remove action ---------- */
function addAction() {
    actionCounter++;
    const aid = actionCounter;
    actionUnits[aid] = 'mm';

    const container = document.getElementById('actionsContainer');
    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm mb-3 action-card';
    card.dataset.actionId = aid;
    card.innerHTML = buildActionHTML(aid);
    container.appendChild(card);
    buildActivityButtons(aid);
    updateActionNumbers();
}

function removeAction(aid) {
    const el = document.querySelector(`[data-action-id="${aid}"]`);
    if (el) el.remove();
    delete actionUnits[aid];
    updateActionNumbers();
    // guarantee at least one action
    if (!document.querySelector('[data-action-id]')) addAction();
}

function updateActionNumbers() {
    const cards = document.querySelectorAll('[data-action-id]');
    cards.forEach((c, i) => {
        const lbl = c.querySelector('.action-number');
        if (lbl) lbl.textContent = `Action ${i+1}`;
        // show/hide remove button
        const btn = c.querySelector('.btn-remove-action');
        if (btn) btn.style.display = cards.length > 1 ? '' : 'none';
    });
}

function buildActionHTML(aid) {
    return `
    <div class="card-header d-flex justify-content-between align-items-center px-4 py-2">
        <strong class="action-number">Action 1</strong>
        <button type="button" class="btn btn-outline-danger btn-sm btn-remove-action" style="display:none"
                onclick="removeAction(${aid})">
            <i class="bi bi-x-lg"></i> Supprimer
        </button>
    </div>
    <div class="card-body px-4 py-3">
        <!-- Type d'activit√© -->
        <div class="mb-3">
            <label class="form-label"><i class="bi bi-grid-3x3-gap me-1"></i> Type d'activit√©</label>
            <div class="activity-selector act-sel-${aid}"></div>
            <input type="hidden" class="f-type-activite">
        </div>

        <!-- Machine + Mat√©riau -->
        <div class="row g-3 mb-3">
            <div class="col-md-6 grp-machine" style="display:none;">
                <label class="form-label"><i class="bi bi-cpu me-1"></i> Machine</label>
                <select class="form-select f-machine"><option value="">S√©lectionner...</option></select>
            </div>
            <div class="col-md-6 grp-materiau" style="display:none;">
                <label class="form-label"><i class="bi bi-box-seam me-1"></i> Mat√©riau</label>
                <select class="form-select f-materiau"><option value="">S√©lectionner...</option></select>
            </div>
        </div>

        <!-- Dynamic specific fields -->
        <div class="dynamic-fields hidden dyn-container">
            <div class="dynamic-fields-title dyn-title">D√©tails sp√©cifiques</div>

            <!-- Impression 3D -->
            <div class="sp-3d specific-fields" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-speedometer me-1"></i> Poids (grammes)</label>
                        <input type="number" class="form-control f-poids" step="0.1" min="0" placeholder="Ex: 150.5">
                    </div>
                </div>
            </div>

            <!-- D√©coupe Laser / CNC -->
            <div class="sp-decoupe specific-fields" style="display:none;">
                <div class="mb-2">
                    <label class="form-label fw-bold"><i class="bi bi-rulers me-1"></i> Unit√©</label>
                    <div class="filter-tabs unit-tabs">
                        <button type="button" class="filter-tab active" onclick="setActionUnit(${aid},'mm',this)">mm</button>
                        <button type="button" class="filter-tab" onclick="setActionUnit(${aid},'cm',this)">cm</button>
                        <button type="button" class="filter-tab" onclick="setActionUnit(${aid},'m',this)">m</button>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-ruler me-1"></i> Longueur</label>
                        <div class="input-group">
                            <input type="number" class="form-control f-longueur" step="0.1" min="0" placeholder="0"
                                   oninput="calcActionSurface(${aid})">
                            <span class="input-group-text unit-label">mm</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-arrows-angle-expand me-1"></i> Largeur</label>
                        <div class="input-group">
                            <input type="number" class="form-control f-largeur" step="0.1" min="0" placeholder="0"
                                   oninput="calcActionSurface(${aid})">
                            <span class="input-group-text unit-label">mm</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-calculator me-1"></i> Surface</label>
                        <input type="text" class="form-control f-surface" readonly placeholder="Auto" style="background:var(--ft-bg);">
                    </div>
                </div>
            </div>

            <!-- Impression Papier -->
            <div class="sp-papier specific-fields" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-file-earmark me-1"></i> Nb feuilles</label>
                        <input type="number" class="form-control f-nb-feuilles" min="0" placeholder="Ex: 10">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-aspect-ratio me-1"></i> Format</label>
                        <select class="form-select f-format-papier">
                            <option value="">S√©lectionner...</option>
                            <option value="A0">A0 (1189√ó841)</option>
                            <option value="A1">A1 (841√ó594)</option>
                            <option value="A2">A2 (594√ó420)</option>
                            <option value="A3">A3 (420√ó297)</option>
                            <option value="A4">A4 (297√ó210)</option>
                            <option value="A5">A5 (210√ó148)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="bi bi-palette me-1"></i> Couleur / N&B</label>
                        <select class="form-select f-impression-couleur">
                            <option value="">S√©lectionner...</option>
                            <option value="couleur">üé® Couleur</option>
                            <option value="nb">‚¨õ Noir & Blanc</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Thermoformage -->
            <div class="sp-thermo specific-fields" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-fire me-1"></i> Nb feuilles plastique</label>
                        <input type="number" class="form-control f-nb-feuilles-plastique" min="0" placeholder="Ex: 2">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Type de feuille</label>
                        <select class="form-select f-type-feuille">
                            <option value="">S√©lectionner...</option>
                            <option value="opaque">Feuille opaque</option>
                            <option value="transparente">Feuille transparente</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commentaire par action -->
        <div class="mt-3">
            <label class="form-label"><i class="bi bi-chat-left-text me-1"></i> Commentaire (optionnel)</label>
            <input type="text" class="form-control f-commentaire" placeholder="D√©tail de cette action...">
        </div>
    </div>`;
}

/* ---------- Activity buttons per action ---------- */
function buildActivityButtons(aid) {
    const container = document.querySelector(`.act-sel-${aid}`);
    container.innerHTML = '';
    REF_DATA.types_activite.forEach(t => {
        const btn = document.createElement('div');
        btn.className = 'activity-type-btn';
        btn.dataset.typeId = t.id;
        btn.dataset.typeNom = t.nom;
        btn.innerHTML = `<span class="icon">${t.icone}</span><span class="label">${t.nom}</span>`;
        btn.addEventListener('click', () => selectActionType(aid, t));
        container.appendChild(btn);
    });
}

function selectActionType(aid, type) {
    const card = document.querySelector(`[data-action-id="${aid}"]`);
    card.querySelectorAll('.activity-type-btn').forEach(b => b.classList.remove('selected'));
    card.querySelector(`.activity-type-btn[data-type-id="${type.id}"]`).classList.add('selected');
    qs(aid, '.f-type-activite').value = type.id;

    // machines
    const mg = card.querySelector('.grp-machine');
    const ms = card.querySelector('.f-machine');
    const filteredM = REF_DATA.machines.filter(m => m.type_activite_id === type.id && (m.statut || 'disponible') === 'disponible');
    const allM = REF_DATA.machines.filter(m => m.type_activite_id === type.id);
    const unavail = allM.length - filteredM.length;
    if (filteredM.length > 0) {
        mg.style.display = '';
        ms.innerHTML = '<option value="">S√©lectionner...</option>';
        filteredM.forEach(m => ms.innerHTML += `<option value="${m.id}">${m.nom}</option>`);
        if (unavail > 0) ms.innerHTML += `<option disabled>‚îÄ‚îÄ ${unavail} indisponible(s) ‚îÄ‚îÄ</option>`;
    } else {
        mg.style.display = allM.length > 0 ? '' : 'none';
        ms.innerHTML = allM.length > 0 ? `<option value="">Toutes indisponibles</option>` : '<option value="">Aucune</option>';
    }

    // materials
    const mtg = card.querySelector('.grp-materiau');
    const mts = card.querySelector('.f-materiau');
    const filteredMat = REF_DATA.materiaux.filter(m => m.type_activite_id === type.id);
    if (filteredMat.length > 0) {
        mtg.style.display = '';
        mts.innerHTML = '<option value="">S√©lectionner...</option>';
        filteredMat.forEach(m => mts.innerHTML += `<option value="${m.id}">${m.nom}</option>`);
    } else {
        mtg.style.display = 'none';
        mts.innerHTML = '<option value="">Aucun</option>';
    }

    // specific fields
    showActionSpecificFields(aid, type.nom);
}

function showActionSpecificFields(aid, typeName) {
    const card = document.querySelector(`[data-action-id="${aid}"]`);
    const dyn = card.querySelector('.dyn-container');
    const title = card.querySelector('.dyn-title');
    card.querySelectorAll('.specific-fields').forEach(f => f.style.display = 'none');

    let show = true;
    if (typeName === 'Impression 3D') {
        card.querySelector('.sp-3d').style.display = '';
        title.textContent = 'D√©tails Impression 3D';
    } else if (DECOUPE_TYPES.includes(typeName)) {
        card.querySelector('.sp-decoupe').style.display = '';
        title.textContent = 'Calculateur de surface';
    } else if (typeName === 'Impression Papier') {
        card.querySelector('.sp-papier').style.display = '';
        title.textContent = 'D√©tails Impression Papier';
    } else if (typeName === 'Thermoformage') {
        card.querySelector('.sp-thermo').style.display = '';
        title.textContent = 'D√©tails Thermoformage';
    } else {
        show = false;
    }
    dyn.classList.toggle('hidden', !show);
}

/* ---------- Decoupe unit per action ---------- */
const UNIT_TO_MM = { mm: 1, cm: 10, m: 1000 };

function setActionUnit(aid, unit, btn) {
    actionUnits[aid] = unit;
    const card = document.querySelector(`[data-action-id="${aid}"]`);
    card.querySelectorAll('.unit-tabs .filter-tab').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');
    card.querySelectorAll('.unit-label').forEach(el => el.textContent = unit);
    calcActionSurface(aid);
}

function calcActionSurface(aid) {
    const l = parseFloat(qs(aid, '.f-longueur')?.value) || 0;
    const w = parseFloat(qs(aid, '.f-largeur')?.value) || 0;
    const f = UNIT_TO_MM[actionUnits[aid]] || 1;
    const s = (l * f * w * f) / 1e6;
    const el = qs(aid, '.f-surface');
    if (el) el.value = s > 0 ? `${s.toFixed(4)} m¬≤` : '';
}

/* ---------- Add referent on the fly ---------- */
async function addNewReferent() {
    const nom = prompt('Nom du r√©f√©rent √† ajouter :');
    if (!nom || !nom.trim()) return;
    const res = await fetch('/api/referents', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nom: nom.trim()})
    });
    const data = await res.json();
    if (data.success && data.id) {
        REF_DATA.referents.push({id: data.id, nom: nom.trim(), actif: 1});
        REF_DATA.referents.sort((a, b) => a.nom.localeCompare(b.nom));
        populateGlobalSelects();
        document.getElementById('referent_id').value = data.id;
        showToast(`R√©f√©rent "${nom.trim()}" ajout√©`);
    }
}

/* ========== SUBMIT ========== */
async function submitForm() {
    await doSubmit(false);
}

async function submitAndNew() {
    await doSubmit(true);
}

async function doSubmit(andNew) {
    if (!parseInt(CURRENT_USER)) {
        showToast("Veuillez s√©lectionner un pr√©parateur dans l'en-t√™te de l'application", 'error');
        return;
    }

    // Collect actions
    const actionCards = document.querySelectorAll('[data-action-id]');
    const actions = [];
    let valid = true;
    actionCards.forEach(card => {
        const aid = card.dataset.actionId;
        const typeId = card.querySelector('.f-type-activite').value;
        if (!typeId) {
            valid = false;
            card.classList.add('border-danger');
            setTimeout(() => card.classList.remove('border-danger'), 2000);
            return;
        }
        const unit = actionUnits[aid] || 'mm';
        const factor = UNIT_TO_MM[unit] || 1;
        const rawL = parseFloat(card.querySelector('.f-longueur')?.value) || 0;
        const rawW = parseFloat(card.querySelector('.f-largeur')?.value) || 0;
        actions.push({
            type_activite_id: parseInt(typeId),
            machine_id: parseInt(card.querySelector('.f-machine')?.value) || null,
            materiau_id: parseInt(card.querySelector('.f-materiau')?.value) || null,
            poids_grammes: parseFloat(card.querySelector('.f-poids')?.value) || null,
            longueur_mm: rawL ? rawL * factor : null,
            largeur_mm: rawW ? rawW * factor : null,
            nb_feuilles: parseInt(card.querySelector('.f-nb-feuilles')?.value) || null,
            format_papier: card.querySelector('.f-format-papier')?.value || null,
            impression_couleur: card.querySelector('.f-impression-couleur')?.value || '',
            nb_feuilles_plastique: parseInt(card.querySelector('.f-nb-feuilles-plastique')?.value) || null,
            type_feuille: card.querySelector('.f-type-feuille')?.value || null,
            commentaire: card.querySelector('.f-commentaire')?.value || '',
        });
    });

    if (!valid) {
        showToast('Chaque action doit avoir un type d\'activit√© s√©lectionn√©', 'error');
        return;
    }
    if (actions.length === 0) {
        showToast('Ajoutez au moins une action', 'error');
        return;
    }

    const payload = {
        date_saisie: document.getElementById('date_saisie').value,
        preparateur_id: parseInt(CURRENT_USER),
        classe_id: parseInt(document.getElementById('classe_id').value) || null,
        referent_id: parseInt(document.getElementById('referent_id').value) || null,
        projet_nom: document.getElementById('projet_nom').value || '',
        actions: actions
    };

    try {
        const res = await fetch('/api/consommations/batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
            const n = result.count || actions.length;
            showToast(`${n} action(s) enregistr√©e(s) !`);
            if (andNew) {
                resetActions();
            } else {
                resetForm();
            }
            loadRecent();
        } else {
            showToast('Erreur : ' + (result.error || 'inconnue'), 'error');
        }
    } catch (err) {
        showToast('Erreur r√©seau : ' + err.message, 'error');
    }
}

/* ---------- reset ---------- */
function resetActions() {
    document.getElementById('actionsContainer').innerHTML = '';
    actionCounter = 0;
    actionUnits = {};
    addAction();
}

function resetForm() {
    document.getElementById('date_saisie').value = '';
    document.getElementById('projet_nom').value = '';
    document.getElementById('classe_id').value = '';
    document.getElementById('referent_id').value = '';
    setDefaultDate();
    resetActions();
}

/* ========== Recent entries ========== */
async function loadRecent() {
    try {
        const res = await fetch('/api/consommations?per_page=10&page=1');
        const result = await res.json();
        const tbody = document.getElementById('recentTable');

        if (!result.data || result.data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5">
                <div class="empty-state"><i class="bi bi-inbox"></i><p>Aucune saisie pour le moment</p></div>
            </td></tr>`;
            return;
        }

        tbody.innerHTML = result.data.map(row => `
            <tr>
                <td>${formatDate(row.date_saisie)}</td>
                <td>${row.projet_nom ? `<span class="text-muted small">${row.projet_nom}</span>` : '<span class="text-muted">‚Äî</span>'}</td>
                <td>${getBadgeHTML(row.type_activite_nom, row.badge_class)}</td>
                <td>${row.machine_nom || '<span class="text-muted">‚Äî</span>'}</td>
                <td>${getMaterialImg(row.materiau_nom)}${row.materiau_nom || '<span class="text-muted">‚Äî</span>'}</td>
                <td>${getDetailsText(row)}</td>
                <td>${row.preparateur_nom || '<span class="text-muted">‚Äî</span>'}</td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteEntry(${row.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Erreur chargement r√©cents:', err);
    }
}

function getDetailsText(row) {
    const parts = [];
    if (row.poids_grammes) parts.push(`${row.poids_grammes}g`);
    if (row.surface_m2) parts.push(`${row.surface_m2.toFixed(4)} m¬≤`);
    if (row.nb_feuilles) parts.push(`${row.nb_feuilles} feuilles`);
    if (row.nb_feuilles_plastique) parts.push(`${row.nb_feuilles_plastique} feuilles pl.`);
    if (row.classe_nom) parts.push(row.classe_nom);
    if (row.commentaire) parts.push(row.commentaire);
    return parts.join(' | ') || '<span class="text-muted">‚Äî</span>';
}

async function deleteEntry(id) {
    showConfirm('Supprimer', 'Supprimer cette saisie ?', async () => {
        const res = await fetch(`/api/consommations/${id}`, {method: 'DELETE'});
        const result = await res.json();
        if (result.success) {
            showToast('Saisie supprim√©e');
            loadRecent();
        } else {
            showToast('Erreur suppression', 'error');
        }
    });
}
</script>
{% endblock %}
